#!/bin/bash
#SBATCH --job-name=pb
#SBATCH --array=0-{maxidx}
#SBATCH --cpus-per-task=2
#SBATCH --mem-per-cpu=4G
#SBATCH --time=128:00:00
#SBATCH --output={logdir}/pb_%A_%a.out
#SBATCH --error={logdir}/pb_%A_%a.err
#SBATCH --chdir={root}

module load stack/2024-06          # basic toolchain (MPI, GCC, etc.)

PB=/nfs/cds-peta/exports/biol_micro_cds_gr_sunagawa/scratch/aadria/bin/phylobayes/sources/pb

PHY=$(sed -n "$((SLURM_ARRAY_TASK_ID+1))p" {filelist})
DIR=$(dirname "$PHY")
BASE=$(basename "$PHY" .phy)

cd "$DIR"

echo "[pb] running $BASE  (task $SLURM_ARRAY_TASK_ID)"
$PB -d "$BASE.phy" -x 10 10000 -cat -lg "${BASE}_chain1" &
$PB -d "$BASE.phy" -x 10 10000 -cat -lg "${BASE}_chain2" &
wait
echo "[pb] finished $BASE"

